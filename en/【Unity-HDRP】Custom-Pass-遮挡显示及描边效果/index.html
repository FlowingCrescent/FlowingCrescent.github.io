<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="FlowingCrescent&#39;s blog"/>
  <meta name="keyword" content="FlowingCrescent, 流朔, Sand and Foam, gamedev  blog, Blog"/>
  <link rel="shortcut icon" href="/img/avatar/Lloyd.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://flowingcrescent.github.io/en/【Unity-HDRP】Custom-Pass-遮挡显示及描边效果/">
  <title>
    
      【Unity HDRP】Custom Pass 遮挡显示及描边效果 - Sand and Foam - FlowingCrescent&#39;s Blog
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Sand and Foam</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('https://s.im5i.com/2021/06/04/ew36S.png');
      --intro-header-background-image-url-page: url('/https://s.im5i.com/2021/06/04/ew36S.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('https://s.im5i.com/2021/06/04/ew36S.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/https://s.im5i.com/2021/06/04/ew36S.png');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('https://s.im5i.com/2021/06/04/ew36S.png'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Unity" title="Unity">Unity</a>
              
              <a class="tag" href="/tags/#Real Time Rendering" title="Real Time Rendering">Real Time Rendering</a>
              
              <a class="tag" href="/tags/#HDRP" title="HDRP">HDRP</a>
              
            </div>
            <h1>【Unity HDRP】Custom Pass 遮挡显示及描边效果</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by FlowingCrescent on
              2021-06-04
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">17</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">4k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="前言">前言</h2>
<blockquote>
<p>本文初发布于zhihu<br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/170241589">https://zhuanlan.zhihu.com/p/170241589</a></p>
</blockquote>
<p>近日，笔者在进行项目开发时，美术提出了一个需求，要让主角Player有个描边，而且被建筑遮挡的时候能有斜线使其显示出来。<br>
听到这个需求，笔者首先想到的是用后处理把两个效果都做掉，然后便想起了URP的Render Feature，因为笔者曾经看过<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iE411i7Ei">以Render Feature实现遮挡半透明效果的教程</a>。不过不同的是，我们的项目使用的是HDRP，而HDRP中与URP的Render Feature相对应的强大功能为<strong>Custom Pass</strong>。<br>
在学习相关内容时发现，目前关于Custom Pass的资料实在稀少，笔者便决定在自己完成效果并理解原理后写一篇文章作为笔记，也权且当做一个简单的Custom Pass入门教程提供给各位。</p>
<h3 id="关于CustomPass">关于CustomPass</h3>
<p>如上文所言，Custom Pass是个HDRP所独有的强大功能，它能够支持用户自定义Pass，并将其插入渲染管线的绝大部分位置。<br>
而HDRP默认有两种Custom Pass，分别为<strong>DrawRenderersCustomPass</strong>与<strong>FullScreenCustomPass</strong><br>
两者的用途都正如其名，前者为专门渲染某类物体的Pass，后者为全屏后处理的Pass。<br>
<img src="https://s.im5i.com/2021/06/04/ewuqA.png" width="350" alt="about_bg2"></img><br>
而在这次的效果实现中，我们就是要使用这两个Pass来完成。<br>
如果你想知道更多关于CustomPass的内容，可以参考官方文档：<br>
<a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.3/manual/Custom-Pass.html">https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.3/manual/Custom-Pass.html</a></p>
<h3 id="效果实现原理">效果实现原理</h3>
<p>虽然Custom Pass是个新功能，但是我们效果的基本原理其实跟传统的后处理做法是一样的，具体可参考下文<br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98663995">https://zhuanlan.zhihu.com/p/98663995</a></p>
<p>简单来说，遮挡高亮的原理就是以两个深度图来进行对比，一个深度图所存的是Player的深度，一个是场景的深度，当场景的深度值大于Player的深度值（此时的深度图均为Reverse-Z的，即“近大远小”）时，我们即可判定Player被遮挡，便可以在这个像素上进行一些操作了。</p>
<p>而后处理描边的原理可以参考这篇文章，言简意赅地说，就是想办法对我们需要绘制描边的那些物体额外绘制出一个“纯色”（物体为纯白或其他颜色，背景为纯黑）的buffer，然后对那个纯色buffer做边缘检测来进行描边。<br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/95747680">https://zhuanlan.zhihu.com/p/95747680</a><br>
只是这篇文章是利用Stencil Buffer来进行纯色buffer的绘制，我们则直接使用CustomPass即可。<br>
可以说，本文的方法是典型的新瓶装旧酒。</p>
<h3 id="注">注</h3>
<p>*笔者所用Unity版本为2019.4.6f1，HDRP 7.3.1</p>
<p>*笔者经验甚少，难以避免文中出现错误，还请大家不吝斧正，只求轻喷。</p>
<p>本文代码参考自：<a target="_blank" rel="noopener" href="https://github.com/alelievr/HDRP-Custom-Passes">https://github.com/alelievr/HDRP-Custom-Passes</a><br>
且使用了其中的InnerColor图片（被遮挡时的那个斜线Texture）：<img src="https://s.im5i.com/2021/06/04/ew4H0.png" alt="image.png"><br>
这个工程中还有许多CustomPass的使用示例，相当值得学习。</p>
<hr>
<h2 id="绘制“纯色Buffer”及Player深度">绘制“纯色Buffer”及Player深度</h2>
<p>那么我们正式动工。</p>
<p>在HDRP默认场景中创建一个Empty Object，然后给它添加Custom Pass Volume<br>
<img src="https://s.im5i.com/2021/06/04/ewITB.png" alt="image.png"><br>
之后它点击右下角的&quot;+&quot;，选择<strong>DrawRenderersCustomPass，</strong><br>
<strong><img src="https://s.im5i.com/2021/06/04/ewXez.png" alt="image.png"></strong><br>
我们暂时不去修改它的默认值。</p>
<p>那么以Create/Shader/HDRP/Custom Renderers Pass创建我们所需的Pass，并以它创建Material，放进刚刚创建的CustomPass的Overrides/Material中，当然，现在还没什么变化。</p>
<p><img src="https://s.im5i.com/2021/06/04/ewm3s.png" alt="image.png"></p>
<p>那么打开Shader，让我们来粗略地看一下它</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Renderers/NewRenderersCustomPass&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _Color(<span class="string">&quot;Color&quot;</span>, Color) = (<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">        _ColorMap(<span class="string">&quot;ColorMap&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;white&quot;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transparency</span></span><br><span class="line">        _AlphaCutoff(<span class="string">&quot;Alpha Cutoff&quot;</span>, <span class="built_in">Range</span>(<span class="number">0.0</span>, <span class="number">1.0</span>)) = <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> target 4.5</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> only_renderers d3d11 ps4 xboxone vulkan metal switch</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// #pragma enable_d3d11_debug_symbols</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//enable GPU instancing support</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> multi_compile_instancing</span></span><br><span class="line"></span><br><span class="line">    ENDHLSL</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Name <span class="string">&quot;FirstPass&quot;</span></span><br><span class="line">            Tags &#123; <span class="string">&quot;LightMode&quot;</span> = <span class="string">&quot;FirstPass&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">            Blend Off</span><br><span class="line">            ZWrite Off</span><br><span class="line">            ZTest LEqual</span><br><span class="line"></span><br><span class="line">            Cull Back</span><br><span class="line"></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Toggle the alpha test</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> _ALPHATEST_ON</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Toggle transparency</span></span><br><span class="line">            <span class="comment">// #define _SURFACE_TYPE_TRANSPARENT</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Toggle fog on transparent</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> _ENABLE_FOG_ON_TRANSPARENT</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// List all the attributes needed in your shader (will be passed to the vertex shader)</span></span><br><span class="line">            <span class="comment">// you can see the complete list of these attributes in VaryingMesh.hlsl</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> ATTRIBUTES_NEED_TEXCOORD0</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> ATTRIBUTES_NEED_NORMAL</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> ATTRIBUTES_NEED_TANGENT</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// List all the varyings needed in your fragment shader</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> VARYINGS_NEED_TEXCOORD0</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">define</span> VARYINGS_NEED_TANGENT_TO_WORLD</span></span><br><span class="line">            </span><br><span class="line">            <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/RenderPipeline/RenderPass/CustomPass/CustomPassRenderers.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">TEXTURE2D</span>(_ColorMap);</span><br><span class="line">            float4 _ColorMap_ST;</span><br><span class="line">            float4 _Color;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If you need to modify the vertex datas, you can uncomment this code</span></span><br><span class="line">            <span class="comment">// Note: all the transformations here are done in object space</span></span><br><span class="line">            <span class="comment">// #define HAVE_MESH_MODIFICATION</span></span><br><span class="line">            <span class="comment">// AttributesMesh ApplyMeshModification(AttributesMesh input, float3 timeParameters)</span></span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            <span class="comment">//     input.positionOS += input.normalOS * 0.0001; // inflate a bit the mesh to avoid z-fight</span></span><br><span class="line">            <span class="comment">//     return input;</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Put the code to render the objects in your custom pass in this function</span></span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">GetSurfaceAndBuiltinData</span><span class="params">(FragInputs fragInputs, float3 viewDirection, inout PositionInputs posInput, out SurfaceData surfaceData, out BuiltinData builtinData)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                float2 colorMapUv = <span class="built_in">TRANSFORM_TEX</span>(fragInputs.texCoord0.xy, _ColorMap);</span><br><span class="line">                float4 result = <span class="built_in">SAMPLE_TEXTURE2D</span>(_ColorMap, s_trilinear_clamp_sampler, colorMapUv) * _Color;</span><br><span class="line">                <span class="keyword">float</span> opacity = result.a;</span><br><span class="line">                float3 color = result.rgb;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _ALPHATEST_ON</span></span><br><span class="line">                <span class="built_in">DoAlphaTest</span>(opacity, _AlphaCutoff);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Write back the data to the output structures</span></span><br><span class="line">                <span class="built_in">ZERO_INITIALIZE</span>(BuiltinData, builtinData); <span class="comment">// No call to InitBuiltinData as we don&#x27;t have any lighting</span></span><br><span class="line">                builtinData.opacity = opacity;</span><br><span class="line">                builtinData.emissiveColor = <span class="built_in">float3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                surfaceData.color = color;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/RenderPipeline/ShaderPass/ShaderPassForwardUnlit.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> vertex Vert</span></span><br><span class="line">            <span class="meta">#<span class="meta-keyword">pragma</span> fragment Frag</span></span><br><span class="line"></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>粗略地看一看，就可以发现这个Shader的写法还是挺古怪的，颜色的输出在GetSurfaceAndBuiltinData()中，而具体的vert和frag都不涉及。<br>
官方也在这个默认Shader中添加了许多注释，如果你想要更加深入地学习，推荐把注释都读一遍。</p>
<p>那么回想一下我们的目的，我们打算“将Player以白色渲染到一张黑底图片上”。那么写起来也非常简单了，我们只需要让输出的color永远为白色(1, 1, 1)即可。<br>
因此，我们只需要将GetSurfaceAndBuiltinData()修改一下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetSurfaceAndBuiltinData</span><span class="params">(FragInputs fragInputs, float3 viewDirection, inout PositionInputs posInput, out SurfaceData surfaceData, out BuiltinData builtinData)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="comment">// Write back the data to the output structures</span></span><br><span class="line">      <span class="built_in">ZERO_INITIALIZE</span>(BuiltinData, builtinData); <span class="comment">// No call to InitBuiltinData as we don&#x27;t have any lighting</span></span><br><span class="line">      builtinData.opacity = <span class="number">1</span>;</span><br><span class="line">      builtinData.emissiveColor = <span class="built_in">float3</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      surfaceData.color = _Color;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>哦差点忘了，我们还没写入深度！要记得把Pass中的<strong>ZWrite Off改成Zwrite On</strong>~<br>
（当然，我们可以尽可能地把Shader中没用到那些内容删除干净，不过这并不是本文的重点，就不多提了）<br>
保存Shader之后，我们会发现场景内所有物体都变成了白色<br>
<img src="https://s.im5i.com/2021/06/04/ewPpo.png" alt="image.png"><br>
由于一些后处理的存在，这些物体的颜色不是纯白</p>
<p>此时我们便需要调整Custom Pass中的一些设置了<br>
<img src="https://s.im5i.com/2021/06/04/eNDbW.png" alt="image.png"><br>
将Target Color Buffer 和Target Depth Buffer都设置为Custom，前者的设置是因为我们要让物体的“白色”绘制在另一张图上，而Depth Buffer的设置便是“单独绘制Player深度”了，相当便利。<br>
而ClearFlag的设置，就是让我们在每次调用这两个Buffer之前，都将这两个Buffer清空。<br>
之后，我们便需要为Player单独创立一个层，并且将我们要当做Player的物体的层设置为&quot;Player&quot;，我选择的是场景中的Workbench。<br>
此时我们看场景，依旧与最初没有区别，但这并不代表我们之前是白干的，让我们打开Frame Debugger，找到Custom Pass的内容，便可以看见我们已经切实地“将Player以白色画在了黑底的图上”。<br>
<img src="https://s.im5i.com/2021/06/04/eNUox.png" alt="image.png"></p>
<p>而Custom Depth Buffer在Frame Debugger中看不到，笔者这里通过RenderDoc来查看，可以看见Workbench的深度被单独绘制了。<br>
<img src="https://s.im5i.com/2021/06/04/eNixQ.png" alt="image.png"><br>
而图像上下翻转，应当是DX与OpenGL的纹理坐标轴不同的缘故，无伤大雅。</p>
<hr>
<h2 id="绘制描边与遮挡显示">绘制描边与遮挡显示</h2>
<p>那么我们来到了第二步，为了让效果更明显，我们先放一个Plane挡住一半的Workbench，就跟头图一样。<br>
和第一步类似，我们要先在Custom Pass中新建一个FullScreenCustomPass，然后新建一个Create/Shader/HDRP/Custom FullScreen Pass，并以其创建一个Material放入Custom Pass中，依旧没什么效果。<br>
那么我们打开Shader看看</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;FullScreen/NewFullScreenCustomPass&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    HLSLINCLUDE</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> vertex Vert</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> target 4.5</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">pragma</span> only_renderers d3d11 ps4 xboxone vulkan metal switch</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/RenderPipeline/RenderPass/CustomPass/CustomPassCommon.hlsl&quot;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The PositionInputs struct allow you to retrieve a lot of useful information for your fullScreenShader:</span></span><br><span class="line">    <span class="comment">// struct PositionInputs</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     float3 positionWS;  // World space position (could be camera-relative)</span></span><br><span class="line">    <span class="comment">//     float2 positionNDC; // Normalized screen coordinates within the viewport    : [0, 1) (with the half-pixel offset)</span></span><br><span class="line">    <span class="comment">//     uint2  positionSS;  // Screen space pixel coordinates                       : [0, NumPixels)</span></span><br><span class="line">    <span class="comment">//     uint2  tileCoord;   // Screen tile coordinates                              : [0, NumTiles)</span></span><br><span class="line">    <span class="comment">//     float  deviceDepth; // Depth from the depth buffer                          : [0, 1] (typically reversed)</span></span><br><span class="line">    <span class="comment">//     float  linearDepth; // View space Z coordinate                              : [Near, Far]</span></span><br><span class="line">    <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// To sample custom buffers, you have access to these functions:</span></span><br><span class="line">    <span class="comment">// But be careful, on most platforms you can&#x27;t sample to the bound color buffer. It means that you</span></span><br><span class="line">    <span class="comment">// can&#x27;t use the SampleCustomColor when the pass color buffer is set to custom (and same for camera the buffer).</span></span><br><span class="line">    <span class="comment">// float4 SampleCustomColor(float2 uv);</span></span><br><span class="line">    <span class="comment">// float4 LoadCustomColor(uint2 pixelCoords);</span></span><br><span class="line">    <span class="comment">// float LoadCustomDepth(uint2 pixelCoords);</span></span><br><span class="line">    <span class="comment">// float SampleCustomDepth(float2 uv);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// There are also a lot of utility function you can use inside Common.hlsl and Color.hlsl,</span></span><br><span class="line">    <span class="comment">// you can check them out in the source code of the core SRP package.</span></span><br><span class="line"></span><br><span class="line">    <span class="function">float4 <span class="title">FullScreenPass</span><span class="params">(Varyings varyings)</span> : SV_Target</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">        <span class="built_in">UNITY_SETUP_STEREO_EYE_INDEX_POST_VERTEX</span>(varyings);</span><br><span class="line">        <span class="keyword">float</span> depth = <span class="built_in">LoadCameraDepth</span>(varyings.positionCS.xy);</span><br><span class="line">        PositionInputs posInput = <span class="built_in">GetPositionInput</span>(varyings.positionCS.xy, _ScreenSize.zw, depth, UNITY_MATRIX_I_VP, UNITY_MATRIX_V);</span><br><span class="line">        float3 viewDirection = <span class="built_in">GetWorldSpaceNormalizeViewDir</span>(posInput.positionWS);</span><br><span class="line">        float4 color = <span class="built_in">float4</span>(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the camera color buffer at the mip 0 if we&#x27;re not at the before rendering injection point</span></span><br><span class="line">        <span class="keyword">if</span> (_CustomPassInjectionPoint != CUSTOMPASSINJECTIONPOINT_BEFORE_RENDERING)</span><br><span class="line">            color = <span class="built_in">float4</span>(<span class="built_in">CustomPassLoadCameraColor</span>(varyings.positionCS.xy, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add your custom pass code here</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fade value allow you to increase the strength of the effect while the camera gets closer to the custom pass volume</span></span><br><span class="line">        <span class="keyword">float</span> f = <span class="number">1</span> - <span class="built_in">abs</span>(_FadeValue * <span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">float4</span>(color.rgb + f, color.a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ENDHLSL</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Name <span class="string">&quot;Custom Pass 0&quot;</span></span><br><span class="line"></span><br><span class="line">            ZWrite Off</span><br><span class="line">            ZTest Always</span><br><span class="line">            Blend SrcAlpha OneMinusSrcAlpha</span><br><span class="line">            Cull Off</span><br><span class="line"></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">                <span class="meta">#<span class="meta-keyword">pragma</span> fragment FullScreenPass</span></span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Fallback Off</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>和之前的Custom Renderers Pass写法很是相似，我们只需要关注FullScreenPass()即可，不过这次这个函数就是Fragment Shader。<br>
笔者最初使用时以为跟以前的OnRenderImage一样，以为我们是拿到了后处理前的CameraTexture，然后在它的基础上进行处理。但是眼尖的朋友可以发现，这个Shader中有一个<strong>Blend SrcAlpha OneMinusSrcAlpha</strong>，那就说明我们渲染的东西是个半透明的Texture。<br>
更通俗来讲，Custom Renderers Pass就是渲染出一个图片与我们的场景图混合，默认的混合方式就是这个透明度混合。</p>
<h3 id="描边方式的选择">描边方式的选择</h3>
<p>那么我们先进行描边操作，后处理描边可以使用Sobel/Prewitt等算子进行卷积计算，我最初也是那么打算的，之前那个使用Stencil Buffer做描边的文章也确实是那么做的，但是笔者参考了前言中的那个Github工程后发现，即便是只“上下左右采样四次取最大值”带来的效果也同样不错。<br>
而这个似乎就叫Max Filter，也就是“对 data 进行滤波，用邻域 r 内的最大值替换图像中的值”。<br>
但是如果只是如此，会导致物体内部一片纯色，因此的时候还需要减去原本Custom Color所绘制的纯色区域，留下的就是描边了。正因为还需要这一步，Max Filter并不能通用在大部分以法线或深度来检测边缘的场合，而反过来讲，Max Filter也是在本项目中的特化方法。<br>
笔者将两个方法都做了一次：<br>
<img src="https://s.im5i.com/2021/06/04/eNx8q.png" alt="image.png"><br>
可以看见，基本没什么区别，但如果仔细看的话，可以发现Sobel的描边会比Max的更圆滑一些，但要看出这个也确实是需要写轮眼的功力了，而且这也只是Max用上下左右4次采样而已，它也可以再加斜着的四个方向，还是比Sobel少采样一次呢。<br>
不过，即便Max Filter比我们常用的Sobel Filter更风光，但别忘了我们还有Roberts算子（<img src="https://s.im5i.com/2021/06/04/eNLKD.png" alt="image.png">），它也只用采样四次。那么同样的，笔者也尝试了一下：<br>
<img src="https://s.im5i.com/2021/06/04/eNYHy.png" alt="image.png"><br>
显然，效果也不错<br>
好吧，Roberts确实也不错，而它也不用减去纯色的那步骤……</p>
<p>即便如此，我相信以这种常见方式进行描边大家也都看腻了，笔者在此还是选择Max Filter，权当一次思维拓展吧。各位在实践的时候大可以选择以Roberts算子来描边。</p>
<h3 id="正式动工">正式动工</h3>
<p>首先，我们要定义每次采样的不同方向。<br>
以下的代码部分写在FullScreenPass之前。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> c45 0.707107</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> c225 0.9238795</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> s225 0.3826834</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXSAMPLES 16</span></span><br><span class="line"><span class="keyword">static</span> float2 offsets[MAXSAMPLES] = &#123;</span><br><span class="line">    <span class="built_in">float2</span>(<span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    <span class="built_in">float2</span>(<span class="number">-1</span>, <span class="number">0</span>),</span><br><span class="line">    <span class="built_in">float2</span>(<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="built_in">float2</span>(<span class="number">0</span>, <span class="number">-1</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">float2</span>(c45, c45),</span><br><span class="line">    <span class="built_in">float2</span>(c45, -c45),</span><br><span class="line">    <span class="built_in">float2</span>(-c45, c45),</span><br><span class="line">    <span class="built_in">float2</span>(-c45, -c45),</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">float2</span>(c225, s225),</span><br><span class="line">    <span class="built_in">float2</span>(c225, -s225),</span><br><span class="line">    <span class="built_in">float2</span>(-c225, s225),</span><br><span class="line">    <span class="built_in">float2</span>(-c225, -s225),</span><br><span class="line">    <span class="built_in">float2</span>(s225, c225),</span><br><span class="line">    <span class="built_in">float2</span>(s225, -c225),</span><br><span class="line">    <span class="built_in">float2</span>(-s225, c225),</span><br><span class="line">    <span class="built_in">float2</span>(-s225, -c225)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>offsets数组便是我们所存的各次采样的方向，前四个值代表上下右左四个方向，之后的四个为斜向45°的四个方向，c45即为cos(45°)。而c225则是代表cos(22.5°)，s即为sin。这个采样数组的设置也是为了方便之后对采样次数的调节，我们接下来就马上会看到。</p>
<p>那么为了描边，我们需要一个调整采样次数的变量，以及调整描边宽度及描边颜色的变量<br>
因此在开头添加Properties：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">    _SamplePrecision (<span class="string">&quot;Sampling Precision&quot;</span>, <span class="built_in">Range</span>(<span class="number">1</span>, <span class="number">3</span>)) = <span class="number">1</span></span><br><span class="line">    _OutlineWidth (<span class="string">&quot;Outline Width&quot;</span>, Float) = <span class="number">2</span></span><br><span class="line">    _OuterColor (<span class="string">&quot;Outer Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得要将它们再声明一次。</p>
<p>那么描边的内容比较少，也比较简单，大家光看注释相信也能懂：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function">float4 <span class="title">FullScreenPass</span><span class="params">(Varyings varyings)</span>: SV_Target</span></span><br><span class="line"><span class="function">  &#123;</span></span><br><span class="line">      <span class="built_in">UNITY_SETUP_STEREO_EYE_INDEX_POST_VERTEX</span>(varyings);</span><br><span class="line">      <span class="keyword">float</span> depth = <span class="built_in">LoadCameraDepth</span>(varyings.positionCS.xy);</span><br><span class="line">      PositionInputs posInput = <span class="built_in">GetPositionInput</span>(varyings.positionCS.xy, _ScreenSize.zw, depth, UNITY_MATRIX_I_VP, UNITY_MATRIX_V);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//CustomColorBuffer中本次处理的像素的颜色值</span></span><br><span class="line">      float4 c = <span class="built_in">LoadCustomColor</span>(posInput.positionSS);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//调整采样次数以4, 8, 16幂次增长</span></span><br><span class="line">      <span class="keyword">int</span> sampleCount = <span class="built_in">min</span>(<span class="number">2</span> * <span class="built_in">pow</span>(<span class="number">2</span>, _SamplePrecision), MAXSAMPLES) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算每像素之间的uv差</span></span><br><span class="line">      float2 uvOffsetPerPixel = <span class="number">1.0</span> / _ScreenSize .xy;</span><br><span class="line"></span><br><span class="line">      float4 outline = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; sampleCount; ++ i)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">//取sampleCount次采样中的最大值</span></span><br><span class="line">          outline = <span class="built_in">max</span>(<span class="built_in">SampleCustomColor</span>(posInput.positionNDC + uvOffsetPerPixel * _OutlineWidth * offsets[i]), outline);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//去掉原本纯色块的部分</span></span><br><span class="line">      outline *= _OuterColor * (<span class="number">1</span> - c.a);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> outline;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>要注意的是LoadCustomColor()使用的是positionSS（Screen Space），而SampleCustomColor()使用的是positionNDC。当然如果想用SampleCustomColor()取得该像素的颜色也是可以的，只是笔者这里示范一下两个函数的用法。</p>
<p>那么我们保存Shader，便可以看见场景中Player层的物体已经被描上一层黄边了。</p>
<p>接下来就是遮挡显示的内容了，为了实现被遮挡的内容，我们需要定义斜线填充图的颜色、斜线图的Texture以及这Texture的重复次数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">    _SamplePrecision (<span class="string">&quot;Sampling Precision&quot;</span>, <span class="built_in">Range</span>(<span class="number">1</span>, <span class="number">3</span>)) = <span class="number">1</span></span><br><span class="line">    _OutlineWidth (<span class="string">&quot;Outline Width&quot;</span>, Float) = <span class="number">1</span></span><br><span class="line">    _OuterColor (<span class="string">&quot;Outer Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    _InnerColor (<span class="string">&quot;Inner Color&quot;</span>, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    _Texture (<span class="string">&quot;Texture&quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;black&quot;</span> &#123; &#125;</span><br><span class="line">    _TextureSize (<span class="string">&quot;Texture Pixels Size&quot;</span>, <span class="keyword">float</span>) = <span class="number">32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际的代码量同样很少，也比较简单：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">      ......</span><br><span class="line">      <span class="comment">//非描边的内容用斜线填充了，则不再需要这步操作了</span></span><br><span class="line"><span class="comment">//outline *= _OuterColor * (1 - c.a);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//读取CustomDepthBuffer</span></span><br><span class="line">      <span class="keyword">float</span> d = <span class="built_in">LoadCustomDepth</span>(posInput.positionSS);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//进行深度的判断，如果判定为被遮挡则用我们设置的透明度，反之则为0。</span></span><br><span class="line">      <span class="comment">//0.000001为bias，避免浮点数的精度问题导致的误差。</span></span><br><span class="line">      <span class="keyword">float</span> alphaFactor = (depth &gt; d + <span class="number">0.000001</span>) ?_BehindFactor: <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//对InnerColorTexture进行采样</span></span><br><span class="line">      float4 innerColor = <span class="built_in">SAMPLE_TEXTURE2D</span>(_Texture, s_trilinear_repeat_sampler, posInput.positionSS / _TextureSize) * _InnerColor;</span><br><span class="line">      </span><br><span class="line">      innerColor.a *= alphaFactor;</span><br><span class="line"></span><br><span class="line">      float4 output = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//将描边赋值给output</span></span><br><span class="line">      output = <span class="built_in">lerp</span>(output, _OuterColor * <span class="built_in">float4</span>(outline.rgb, <span class="number">1</span>), outline.a);</span><br><span class="line">      <span class="comment">//将纯色色块覆盖的区域以InnerColor替代</span></span><br><span class="line">      output = <span class="built_in">lerp</span>(output, innerColor * <span class="built_in">float4</span>(c.rgb, <span class="number">1</span>), c.a);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> output;</span><br></pre></td></tr></table></figure>
<p>那么保存Shader之后，就大功告成了。<br>
<img src="https://s.im5i.com/2021/06/04/ew36S.png" alt="image.png"><br>
笔者把遮挡颜色调为了橙色，效果还是不错的</p>
<p>如果之后美术提出，要让敌人也有描边，而且描边颜色还得不同，那简直是轻而易举，相信读完本文的人是一定会做的。<br>
<img src="https://s.im5i.com/2021/06/04/eNsZh.png" alt="image.png"></p>
<h2 id="总结">总结</h2>
<p>做了这个简单的案例之后，我们便学会了Custom Pass的基本用法，也了解了它的基本原理，虽然它显得很高大上，不过用起来其实还是比较方便的。<br>
希望这篇文章能够对将来学习HDRP Custom Pass相关内容的人有所帮助。<br>
也感谢在此领域不断开拓的前人，让我们能够比较容易地学到这些内容。</p>
<h2 id="参考资料">参考资料</h2>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.3/manual/Custom-Pass.html">https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.3/manual/Custom-Pass.html</a><br>
<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iE411i7Ei">https://www.bilibili.com/video/BV1iE411i7Ei</a><br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/98663995">https://zhuanlan.zhihu.com/p/98663995</a><br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/95747680">https://zhuanlan.zhihu.com/p/95747680</a><br>
<a target="_blank" rel="noopener" href="https://github.com/alelievr/HDRP-Custom-Passes">https://github.com/alelievr/HDRP-Custom-Passes</a><br>
<a target="_blank" rel="noopener" href="https://reference.wolfram.com/language/ref/MaxFilter.html">https://reference.wolfram.com/language/ref/MaxFilter.html</a></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/【Unity-URP】以Render-Feature实现卡通渲染中的刘海投影/" data-toggle="tooltip" data-placement="top" title="【Unity URP】以Render Feature实现卡通渲染中的刘海投影">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/Origin of Blog/" data-toggle="tooltip" data-placement="top" title="本站之伊始">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=【Unity HDRP】Custom Pass 遮挡显示及描边效果&body=Hi,I found this website and thought you might like it http://flowingcrescent.github.io/en/【Unity-HDRP】Custom-Pass-遮挡显示及描边效果/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Fri Jun 04 2021 18:01:26 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">前言</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8ECustomPass"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">关于CustomPass</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">效果实现原理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%B3%A8"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">注</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%BB%98%E5%88%B6%E2%80%9C%E7%BA%AF%E8%89%B2Buffer%E2%80%9D%E5%8F%8APlayer%E6%B7%B1%E5%BA%A6"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">绘制“纯色Buffer”及Player深度</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%BB%98%E5%88%B6%E6%8F%8F%E8%BE%B9%E4%B8%8E%E9%81%AE%E6%8C%A1%E6%98%BE%E7%A4%BA"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">绘制描边与遮挡显示</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%8F%8F%E8%BE%B9%E6%96%B9%E5%BC%8F%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">描边方式的选择</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%AD%A3%E5%BC%8F%E5%8A%A8%E5%B7%A5"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">正式动工</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">总结</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">参考资料</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Unity" title="Unity">Unity</a>
            
            <a class="tag" href="/tags/#Real Time Rendering" title="Real Time Rendering">Real Time Rendering</a>
            
            <a class="tag" href="/tags/#HDRP" title="HDRP">HDRP</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/FlowingCrescent">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://twitter.com/FlowingCrescent">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/FlowingCrescent">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="http://weibo.com/FlowingCrescent">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          FlowingCrescent
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://flowingcrescent.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
